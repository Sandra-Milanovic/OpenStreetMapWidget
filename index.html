<html>
<head>
    <style type="text/css">
        body {
            margin: 0;
            padding: 0;
        }

        #toolbar {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
        }

        #toolbar input[type='button'] {
            float: right;
            background-color: #ccc;
            color: #000;
            border: solid 1px #999;
        }

        #introScreen a.button {
            display: block;
            width: 43%;
            float: left;
            margin:auto;
        }

        #introScreen div.explanation {
            display: block;
            width: 53%;
            float: right;
        }

        #introScreen div.block {
            margin-top: 20px;
            float: left;
            clear: both;
        }


    </style>
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/south-street/jquery-ui.css"/>
    <link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.css"/>
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.ie.css"/>
    <![endif]-->
</head>
<body>
<div id="map" style="height: 400px"></div>
<div id="introScreen" style="height: 512px; width:768px;">
    <div class="block">
        <a href="#" id="openPlacemarkEditor" class="button">Create a placemark map</a>

        <div class="explanation">
            Create a map with a single place marked on
            the map. When someone opens the map, they will
            be shown the place and its description and they will
            get directions on how to arrive to the place from
            location
        </div>
    </div>
    <div class="block">
        <a href="#" id="openRouteEditor" class="button">Create a route map</a>

        <div class="explanation">
            Create a map which displays a fixed, pre-defined route and multiple placemarks (optional)
        </div>
    </div>
    <div class="block">
        <a href="#" id="openAdvancedEditor" class="button">Create an advanced map</a>

        <div class="explanation">
            Create a map which contains multiple placemarks, routes and other shapes
        </div>
    </div>
</div>

<div id="dialog" style="display:none;">
    <a class="shortLink">Short link to this map:</a>
    <input class="shortLink" type="text" style="width:100%"/>
    Embed on your site using an iframe
    <textarea id="iframe" rows="5" style="width:100%"></textarea>
    <a class="link" href="">Full link</a>:
    <textarea class="link" rows="5" style="width:100%"></textarea>
</div>
<div id="toolbar" style="z-index: 10;">
    <input type="button" id="placeButton" value="Place Marker"/>
    <input type="button" id="generateLink" value="Create Link"/>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
<script src="http://code.leafletjs.com/leaflet-0.3.1/leaflet.js"></script>
<!--<script type="text/javascript" src="bitly/jquery.bitly.js"></script>-->
<script type="text/javascript">


    var putParams = function (obj) {
        var arrayStr = [];
        for (key in obj) {
            arrayStr.push(key + "=" + obj[key]);
        }
        return arrayStr.join("&");
    }

    var getShortLink = function (longURL, callback) {
        $.get("https://api-ssl.bitly.com/v3/shorten", {
            access_token:"9e6943f1fa1d50b25cd1cca6e5437a9ab5f2a1a7",
            longUrl:longURL
        }, function (data) {
            console.log(data);
            callback(data.data.url);
        });
    }

    $(window).resize(function () {
        $("#map").width($(window).width());
        $("#map").height($(window).height());
    })

    $(document).ready(function () {

        $('a.button').button();

        $("#dialog").dialog({
            autoOpen:false,
            bgIframe:true,
            title:"Embed map",
            width:500,
            height:400
        });
        $("#introScreen").dialog({
            autoOpen:true,
            bgIframe:true,
            title:"Welcome to osmwidget",
            width:640,
            height:380
        });
        $("#map").width($(window).width());
        $("#map").height($(window).height());

        var map = new L.Map('map');
        var layer = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution:'Copyright (C) OpenStreetMap.org',
            maxZoom:18
        });
        map.addLayer(layer);
        map.setView(new L.LatLng(41.99477, 21.42785), 8);

        var placeMark = null;
        var placeMark2 = null;

        var placementMode = false;
            map.on("click", function(e){    
            if (placementMode) {
                if (placeMark) {
                    map.removeLayer(placeMark);
                    }
                    placeMark = new L.Marker(e.latlng, {draggable:true});
                    map.addLayer(placeMark);
                    placementMode = false;
                    $("#placeButton").css({"background-color": "#ccc"});
                    placeMark.on("dragend", function(e){
                        // console.log(placeMark);
                    });
                    placeMark.on("dblclick", function(e){
                        map.removeLayer(placeMark);
                    });
            }
        });
        $("#placeButton").click(function () {
            placementMode = !placementMode;
            if (placementMode) {
                $("#placeButton").css("background-color", "#dd8");
            }
            else {
                $("#placeButton").css("background-color", "#ccc");
            }
        });
        var dialogVisible = false;
        $("#generateLink").click(function () {
            console.log(placeMark);
            $("#dialog").dialog('open');
            var hostPart = window.location.toString().split("#")[0];
            hostPart = hostPart.substr(0, hostPart.lastIndexOf('/'));

            var mapPosition = map.getCenter();
            var mapZoom = map.getZoom();
            var link = hostPart + "/show.html?" + putParams({
                lat:mapPosition.lat,
                lng:mapPosition.lng,
                zoom:mapZoom
            });

            if (placeMark != undefined) {
                var markerLatLng = placeMark.getLatLng();
                link += "&" + putParams({marker:markerLatLng.lat + "," + markerLatLng.lng})
            }

            var embedIframe = ['<iframe src="', link, '" width="480" height="420"></iframe>'];
            $("#dialog a").attr("href", link);
            $("#dialog textarea.link, #dialog input.shortLink").val(link);
            $("#dialog #iframe").val(embedIframe.join(""));

            getShortLink(link, function (short) {
                $("#dialog a.shortLink").attr('href', short);
                $("#dialog input.shortLink").val(short);
            });
        });
    });

</script>
</body>
</html>
